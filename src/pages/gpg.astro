---
import PageLayout from '../layouts/PageLayout.astro';
import fs from 'fs';
import path from 'path';
import yaml from 'js-yaml';
import fs from 'fs';
import path from 'path';

interface GPGKey {
  keyId?: string;
  fingerprint?: string;
  created?: string;
  expires?: string;
  file?: string;
  email?: string;
}

interface GPGData {
  current?: GPGKey;
  archived?: GPGKey[];
}

let gpgData: GPGData = {};
try {
  const gpgPath = path.join(process.cwd(), 'src', 'content', 'gpg.yaml');
  if (fs.existsSync(gpgPath)) {
    gpgData = yaml.load(fs.readFileSync(gpgPath, 'utf-8')) as GPGData;
  }
} catch (e) {
  console.error('Error loading gpg.yaml:', e);
}

// Try to load key files
function loadKeyFile(filePath: string): string | null {
  try {
    if (filePath.startsWith('/')) {
      filePath = filePath.substring(1);
    }
    const fullPath = path.join(process.cwd(), 'public', filePath);
    if (fs.existsSync(fullPath)) {
      return fs.readFileSync(fullPath, 'utf-8');
    }
  } catch (error) {
    console.error(`Error loading key file ${filePath}:`, error);
  }
  return null;
}

const currentKeyContent = gpgData.current?.file ? loadKeyFile(gpgData.current.file) : null;
---

<PageLayout title="GPG Public Key">
  <div class="gpg-page">
    <h1>GPG Public Key</h1>
    <p class="intro">My GPG public key for encrypted communications. You can import this key to verify my signed messages and send me encrypted emails.</p>
    
    {gpgData.current && (
      <section class="current-key">
        <h2>Current Key</h2>
        <div class="key-info">
          <div class="info-item">
            <strong>Key ID:</strong> <code>{gpgData.current.keyId}</code>
          </div>
          {gpgData.current.fingerprint && (
            <div class="info-item">
              <strong>Fingerprint:</strong> 
              <code class="fingerprint" id="current-fingerprint">{gpgData.current.fingerprint}</code>
              <button class="copy-btn" onclick={`navigator.clipboard.writeText('${gpgData.current.fingerprint}').then(() => alert('Fingerprint copied!'))`}>
                ðŸ“‹ Copy
              </button>
            </div>
          )}
          {gpgData.current.email && (
            <div class="info-item">
              <strong>Email:</strong> {gpgData.current.email}
            </div>
          )}
          {gpgData.current.created && (
            <div class="info-item">
              <strong>Created:</strong> {new Date(gpgData.current.created).toLocaleDateString()}
            </div>
          )}
          {gpgData.current.expires && (
            <div class="info-item">
              <strong>Expires:</strong> {new Date(gpgData.current.expires).toLocaleDateString()}
            </div>
          )}
        </div>
        
        {currentKeyContent ? (
          <div class="key-content">
            <h3>Public Key</h3>
            <pre><code>{currentKeyContent}</code></pre>
            <a href={gpgData.current.file} download class="download-btn">
              ðŸ“¥ Download Key File
            </a>
          </div>
        ) : (
          <div class="key-content">
            <p class="warning">Key file not found. Please ensure the key file exists at <code>{gpgData.current.file}</code></p>
          </div>
        )}
      </section>
    )}
    
    {gpgData.archived && gpgData.archived.length > 0 && (
      <section class="archived-keys">
        <h2>Archived Keys</h2>
        <p class="note">These are previous keys that are no longer in use but are kept for historical reference.</p>
        {gpgData.archived.map((key, idx) => {
          const archivedKeyContent = key.file ? loadKeyFile(key.file) : null;
          return (
            <div class="archived-key" key={`archived-${idx}`}>
              <h3>Key {key.keyId}</h3>
              <div class="key-info">
                {key.fingerprint && (
                  <div class="info-item">
                    <strong>Fingerprint:</strong> <code>{key.fingerprint}</code>
                  </div>
                )}
                {key.created && (
                  <div class="info-item">
                    <strong>Created:</strong> {new Date(key.created).toLocaleDateString()}
                  </div>
                )}
                {key.expires && (
                  <div class="info-item">
                    <strong>Expired:</strong> {new Date(key.expires).toLocaleDateString()}
                  </div>
                )}
              </div>
              {archivedKeyContent && (
                <details class="key-content">
                  <summary>View Key</summary>
                  <pre><code>{archivedKeyContent}</code></pre>
                  <a href={key.file} download class="download-btn">
                    ðŸ“¥ Download Key File
                  </a>
                </details>
              )}
            </div>
          );
        })}
      </section>
    )}
    
    <section class="instructions">
      <h2>How to Import</h2>
      <ol>
        <li>Download the key file above</li>
        <li>Import it using: <code>gpg --import [key-file]</code></li>
        <li>Verify the fingerprint matches the one shown above</li>
        <li>You can now use this key to verify my signatures or send me encrypted emails</li>
      </ol>
    </section>
  </div>
</PageLayout>

<style>
  .gpg-page {
    max-width: 1000px;
  }
  
  .intro {
    font-size: 1.1rem;
    color: var(--color-text-light);
    margin-bottom: 2rem;
  }
  
  .current-key, .archived-keys, .instructions {
    margin-bottom: 3rem;
    padding: 2rem;
    background: #f9f9f9;
    border-radius: 8px;
  }
  
  .key-info {
    margin: 1.5rem 0;
  }
  
  .info-item {
    margin: 0.75rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .info-item code {
    background: #e8e8e8;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
  }
  
  .fingerprint {
    font-size: 0.9rem;
    word-break: break-all;
  }
  
  .copy-btn {
    background: var(--color-secondary);
    color: white;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: background 0.3s ease;
  }
  
  .copy-btn:hover {
    background: var(--color-primary);
  }
  
  .key-content {
    margin-top: 1.5rem;
  }
  
  .key-content pre {
    background: #2d2d2d;
    color: #f8f8f2;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
    max-height: 400px;
    overflow-y: auto;
  }
  
  .key-content code {
    background: none;
    color: inherit;
    padding: 0;
  }
  
  .download-btn {
    display: inline-block;
    margin-top: 1rem;
    padding: 0.75rem 1.5rem;
    background: var(--color-primary);
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-weight: 500;
    transition: background 0.3s ease;
  }
  
  .download-btn:hover {
    background: var(--color-secondary);
  }
  
  .archived-key {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 4px;
    border-left: 4px solid var(--color-text-light);
  }
  
  .note {
    color: var(--color-text-light);
    font-style: italic;
    margin-bottom: 1rem;
  }
  
  .warning {
    color: var(--color-accent);
    padding: 1rem;
    background: #ffe6e6;
    border-radius: 4px;
  }
  
  .instructions ol {
    line-height: 2;
    padding-left: 1.5rem;
  }
  
  .instructions code {
    background: #f4f4f4;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
  }
</style>

